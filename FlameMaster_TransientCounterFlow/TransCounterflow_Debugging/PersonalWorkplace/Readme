# FlameMaster: tmp_Counterflow debugging

A step-by-step documentation about all the steps can be found in the following

## Installation
cd your/parallel/FlameMaster
git clone git@git.rwth-aachen.de:ITV/FlameMaster.git Repository --branch <our tmp_Counterflow branch>
cd Repository/src/libraries/
git clone https://git.rwth-aachen.de/ITV/eglib.git
cd ../../../
mkdir -p Build && cd Build

module load GCCcore CMake Clang Eigen GCC intel Python/3.9.6 # only on the cluster
CC=clang CXX=clang++ cmake ../Repository -DCMAKE_BUILD_TYPE=Release -DEIGEN_INTEGRATION=ON -DCOMBUSTION_LIBS=ON -DCMAKE_CXX_FLAGS_RELEASE="-O3 -ffast-math -DNDEBUG -march=native -mtune=native" -DCMAKE_C_FLAGS_RELEASE="-O3 -ffast-math -DNDEBUG -march=native -mtune=native" -DCMAKE_C_FLAGS="" -DCMAKE_Fortran_FLAGS_RELEASE="-O3 -march=native -mtune=native -fPIE" -DINSTALL_SUNDIALS=ON -DSUNDIALS_LAPACK=ON -DDCO_CPP_BASE_DIR=~/Documents/ITV/dco/dco_repository/dco_cpp_dev/dco_cpp_dev/ -DCHEMKIN_TROE=ON -DSENSITIVITY_COMP_MODE=passive -DCOMPILE_FORTRAN_SRC=ON -DTESTS=ON
make install -j12
ctest -j12


## Debugging
Step-by-step protocol

### To get a more detailed error message:
mkdir build_Debug && cd build_Debug
CC=clang CXX=clang++ cmake ../Repository -DCMAKE_BUILD_TYPE=Debug -DEIGEN_INTEGRATION=ON -DCOMBUSTION_LIBS=ON -DCMAKE_CXX_FLAGS_DEBUG="-fPIE -g -O0 -gdwarf-4" -DCMAKE_C_FLAGS_DEBUG="-fPIE -g -O0 -gdwarf-4" -DCMAKE_C_FLAGS="" -DCMAKE_Fortran_FLAGS_DEBUG="-fPIE -g -O0" -DINSTALL_SUNDIALS=ON -DSUNDIALS_LAPACK=ON -DDCO_CPP_BASE_DIR=~/Documents/ITV/dco/dco_repository/dco_cpp_dev/dco_cpp_dev/ -DCHEMKIN_TROE=ON -DSENSITIVITY_COMP_MODE=passive -DCOMPILE_FORTRAN_SRC=ON -DTESTS=ON
make install -j12


### 1: run the code (git version: d50e79cf)
~~~~~~~~~~{sh}
FlameMaster -i FlameMaster.input
~~~~~~~~~~
Output:
~~~~~~~~~~{sh}
FlameMaster written by Heinz Pitsch

version                  4.4.0
executed command         '/rwthfs/rz/cluster/home/cb376114/Programs/FlameMaster/FlameMaster_Branch_tmp_TranCounterflow_GitVersion/Bin/bin/../bin/FlameMan -i FlameMaster.input'
git sha1                 d50e79cf18a8c6736e57183e8d0f37f139f43afc
operating system         Linux, version 4.18.0-553.54.1.el8_10.x86_64
target architechture     x86_64
c++ compiler             Clang, version 15.0.5
c   compiler             Clang, version 15.0.5
bla/lapack vendor        
index size               32 bit

use mechanism file './Mech/N2Diffusion.chmech.pre'
model has 2 species
        0 spherical
        2 linear
        0 non-linear
    -----
        2 / 2 geometry parameters expected

The used model has 0 reactions (reactions for which the forward and backward
direction are specified as separate irreversible reactions are counted twice)

outpath is './Output/'
initial pressure is 1 bar
mixture-averaged transport coefficient evaluation
use multi geometry species transport model
Initialize external thermodynamics model for 2 species
Instantiate external transport model for 2 species
constructed egc mixture-averaged transport model
Use StaticGrid
write output to 'stderr'

Use IDA solver

=================================================================
==155273==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000012515 at pc 0x5636af307b95 bp 0x7ffe2f38b790 sp 0x7ffe2f38af58
WRITE of size 7 at 0x602000012515 thread T0
    #0 0x5636af307b94  (/rwthfs/rz/cluster/home/cb376114/Programs/FlameMaster/FlameMaster_Branch_tmp_TranCounterflow_GitVersion/Bin/bin/FlameMan+0x1979b94)
    #1 0x5636b1a5076d  (/rwthfs/rz/cluster/home/cb376114/Programs/FlameMaster/FlameMaster_Branch_tmp_TranCounterflow_GitVersion/Bin/bin/FlameMan+0x40c276d)
    #2 0x5636b1a86a5a  (/rwthfs/rz/cluster/home/cb376114/Programs/FlameMaster/FlameMaster_Branch_tmp_TranCounterflow_GitVersion/Bin/bin/FlameMan+0x40f8a5a)
    #3 0x5636af36854c  (/rwthfs/rz/cluster/home/cb376114/Programs/FlameMaster/FlameMaster_Branch_tmp_TranCounterflow_GitVersion/Bin/bin/FlameMan+0x19da54c)
    #4 0x5636af35cb5c  (/rwthfs/rz/cluster/home/cb376114/Programs/FlameMaster/FlameMaster_Branch_tmp_TranCounterflow_GitVersion/Bin/bin/FlameMan+0x19ceb5c)
    #5 0x5636af35e044  (/rwthfs/rz/cluster/home/cb376114/Programs/FlameMaster/FlameMaster_Branch_tmp_TranCounterflow_GitVersion/Bin/bin/FlameMan+0x19d0044)
    #6 0x1544ea7f37e4  (/lib64/libc.so.6+0x3a7e4) (BuildId: 8d342f47b7e17a0675aa81230629eb08aeb3e893)
    #7 0x5636af29828d  (/rwthfs/rz/cluster/home/cb376114/Programs/FlameMaster/FlameMaster_Branch_tmp_TranCounterflow_GitVersion/Bin/bin/FlameMan+0x190a28d)

0x602000012515 is located 0 bytes to the right of 5-byte region [0x602000012510,0x602000012515)
allocated by thread T0 here:
    #0 0x5636af35a56d  (/rwthfs/rz/cluster/home/cb376114/Programs/FlameMaster/FlameMaster_Branch_tmp_TranCounterflow_GitVersion/Bin/bin/FlameMan+0x19cc56d)
    #1 0x5636b1a501ab  (/rwthfs/rz/cluster/home/cb376114/Programs/FlameMaster/FlameMaster_Branch_tmp_TranCounterflow_GitVersion/Bin/bin/FlameMan+0x40c21ab)
    #2 0x5636b1a86a5a  (/rwthfs/rz/cluster/home/cb376114/Programs/FlameMaster/FlameMaster_Branch_tmp_TranCounterflow_GitVersion/Bin/bin/FlameMan+0x40f8a5a)
    #3 0x5636af36854c  (/rwthfs/rz/cluster/home/cb376114/Programs/FlameMaster/FlameMaster_Branch_tmp_TranCounterflow_GitVersion/Bin/bin/FlameMan+0x19da54c)
    #4 0x5636af35cb5c  (/rwthfs/rz/cluster/home/cb376114/Programs/FlameMaster/FlameMaster_Branch_tmp_TranCounterflow_GitVersion/Bin/bin/FlameMan+0x19ceb5c)
    #5 0x5636af35e044  (/rwthfs/rz/cluster/home/cb376114/Programs/FlameMaster/FlameMaster_Branch_tmp_TranCounterflow_GitVersion/Bin/bin/FlameMan+0x19d0044)
    #6 0x1544ea7f37e4  (/lib64/libc.so.6+0x3a7e4) (BuildId: 8d342f47b7e17a0675aa81230629eb08aeb3e893)

SUMMARY: AddressSanitizer: heap-buffer-overflow (/rwthfs/rz/cluster/home/cb376114/Programs/FlameMaster/FlameMaster_Branch_tmp_TranCounterflow_GitVersion/Bin/bin/FlameMan+0x1979b94) 
Shadow bytes around the buggy address:
  0x0c047fffa450: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00
  0x0c047fffa460: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00
  0x0c047fffa470: fa fa 02 fa fa fa 02 fa fa fa 02 fa fa fa 07 fa
  0x0c047fffa480: fa fa 02 fa fa fa 02 fa fa fa 07 fa fa fa 06 fa
  0x0c047fffa490: fa fa 00 00 fa fa 02 fa fa fa 02 fa fa fa 02 fa
=>0x0c047fffa4a0: fa fa[05]fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c047fffa4b0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c047fffa4c0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c047fffa4d0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c047fffa4e0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c047fffa4f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07 
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
==155273==ABORTING
~~~~~~~~~~

#### What is the error?
Run the following command:
~~~~~~~~~~{sh}
gdb ~/Programs/FlameMaster/FlameMaster_Branch_tmp_TranCounterflow_GitVersion/Bin/bin/FlameMan
~~~~~~~~~~
Output: 
~~~~~~~~~~{sh}
=================================================================
==45758==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000012515 at pc 0x555556ecdb95 bp 0x7ffffffd9e30 sp 0x7ffffffd95f8
WRITE of size 7 at 0x602000012515 thread T0
[Detaching after fork from child process 47082]
/home/cb376114/Programs/Others/LLVM/bin//llvm-symbolizer: /lib64/libtinfo.so.6: no version information available (required by /home/cb376114/Programs/Others/LLVM/bin//llvm-symbolizer)
    #0 0x555556ecdb94 in __interceptor_strcpy /dev/shm/easybuild/Clang/15.0.5/GCCcore-11.3.0/llvm-project-15.0.5.src/compiler-rt/lib/asan/asan_interceptors.cpp:440:5
    #1 0x55555961676d in TTransCounterflow<T0DSpecies<TMultiGeometryTransportModel>>::InitTTransCounterflow() /rwthfs/rz/cluster/home/cb376114/Programs/FlameMaster/FlameMaster_Branch_tmp_TranCounterflow_GitVersion/Repository/src/FlameMan/TTransCounterflow.hpp:51:2
~~~~~~~~~~

#### How to fix it?
=> File: Repository/src/FlameMan/TTransCounterflow.hpp:51
    -> strcpy( fVariableNames[fP], "PPrime" );
    -> PPrime is not defined in the StartProfileFile
    => replaced P with PPrime in the StartProfileFile
    => modified in the line above "fVariableNames[fP] = new char[5];" to "fVariableNames[fPressure] = new char[7];"
    => Noted an inconsistancy in the code (fP vs fPressure)
    => fPressure is the correct variable -> replaced fP with fPressure


### 2: fixed step 1 and run FlameMaster again
~~~~~~~~~~{sh}
FlameMaster -i FlameMaster.input
~~~~~~~~~~

#### What is the error?
Run the following command:
~~~~~~~~~~{sh}
gbd ~/Programs/FlameMaster/FlameMaster_Branch_tmp_TranCounterflow_GitVersion/Bin/bin/FlameMan
~~~~~~~~~~
Output:
~~~~~~~~~~{sh}
=================================================================
==111909==ERROR: AddressSanitizer: alloc-dealloc-mismatch (operator new [] vs operator delete) on 0x604000010b10
/home/cb376114/Programs/Others/LLVM/bin//llvm-symbolizer: /lib64/libtinfo.so.6: no version information available (required by /home/cb376114/Programs/Others/LLVM/bin//llvm-symbolizer)
    #0 0x564ec4b6ccbd in operator delete(void*) /dev/shm/easybuild/Clang/15.0.5/GCCcore-11.3.0/llvm-project-15.0.5.src/compiler-rt/lib/asan/asan_new_delete.cpp:152:3
    #1 0x564ec72908c9 in TTransCounterflow<T0DSpecies<TMultiGeometryTransportModel>>::ReadStartProfiles(TInputData*) /rwthfs/rz/cluster/home/cb376114/Programs/FlameMaster/FlameMaster_Branch_tmp_TranCounterflow_GitVersion/Repository/src/FlameMan/TTransCounterflow.hpp:322:2
~~~~~~~~~~

#### How to fix it?
    => File: Repository/src/FlameMan/TTransCounterflow.hpp:322
        => "delete filename"; to "delete[] filename;"


### 3: run the code again
=> to fix the warnings - modification of the StartProfileFile
added "time = 0.00001 [ms]" and "CurrTimeStep = 0.00001 [ms]"
=> Note: random numbers


### 4: fixed step 1-3 and run FlameMaster again
~~~~~~~~~~{sh}
error message:
[IDA ERROR]  IDACalcIC
  The linesearch algorithm failed: step too small or too many backtracks.

#error in IDACalcIC
~~~~~~~~~~

#### How to fix it?
This error results from the IDASolver::CalcIC (T0DCVode.cpp)
-> called in InitIDA (TTransCounterflowSolver.hpp)
=> check Initiatize and InitIDA function
    -> 1: fTStart is not correctly initialized (added fTStart = timeStart to the Initialize function - compare with 1DIsoChorSolver.hpp function)
    -> 2: d.yC[something] is nan

